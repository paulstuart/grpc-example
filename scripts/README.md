# Scripts

Utility scripts for testing and managing the gRPC example project.

## populate-users.sh

Populate the database with test user data for development and testing.

### Usage

```bash
# Using default values (localhost:11004, testtoken file)
./scripts/populate-users.sh

# Specify custom API URL and token file
./scripts/populate-users.sh https://api.example.com:11004 /path/to/token

# Or use the justfile command
just docker-populate-users
```

### Features

- Creates 10 diverse test users with different roles (ADMIN, USER, MODERATOR, GUEST)
- Demonstrates all protobuf features: nested messages, oneofs, maps, repeated fields
- Uses JWT authentication from testtoken file
- Color-coded output showing success/failure for each user
- Summary report at the end
- Verifies creation by listing all users

### Test Users

The script creates the following users:

| ID | Username | Role | Contact | Department |
|----|----------|------|---------|------------|
| 1 | alice_admin | ADMIN | alice@example.com | IT |
| 2 | bob_user | USER | bob@example.com | Engineering |
| 3 | charlie_guest | GUEST | +1-555-0103 | External |
| 4 | diana_moderator | MODERATOR | diana@example.com | Community |
| 5 | eve_user | USER | eve@example.com | Engineering |
| 6 | frank_admin | ADMIN | frank@example.com | IT |
| 7 | grace_user | USER | +1-555-0107 | Research |
| 8 | henry_moderator | MODERATOR | henry@example.com | Community |
| 9 | iris_guest | GUEST | iris@partner.com | External |
| 10 | jack_user | USER | jack@example.com | Engineering |

### User Data Features

Each user demonstrates different protobuf features:

- **Oneofs**: Some users have email, others have phone numbers
- **Nested Messages**: Profile with firstName, lastName, bio, addresses
- **Maps**: Metadata with custom key-value pairs, preferences
- **Repeated Fields**: Tags array, multiple addresses
- **Well-Known Types**: Timestamps for creation dates (auto-generated by server)

### test-users.json

The JSON file contains the user data in a format compatible with the gRPC-Gateway REST API.

**Format:**
```json
[
  {
    "id": 1,
    "username": "alice_admin",
    "role": "ADMIN",
    "email": "alice@example.com",
    "profile": {
      "firstName": "Alice",
      "lastName": "Anderson",
      "bio": "System administrator...",
      "addresses": [...],
      "preferences": {...}
    },
    "tags": ["admin", "senior", "operations"],
    "metadata": {...}
  },
  ...
]
```

### Customizing User Data

To add or modify users:

1. Edit `scripts/test-users.json`
2. Follow the existing format
3. Ensure unique IDs
4. Include required fields: `id`, `username`, `role`
5. Use either `email` or `phone` in the oneof field (not both)

### Examples

**Create a new user manually:**
```bash
curl -k -X POST https://localhost:11004/v1/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $(cat testtoken)" \
  -d '{
    "id": 11,
    "username": "new_user",
    "role": "USER",
    "email": "newuser@example.com",
    "profile": {
      "firstName": "New",
      "lastName": "User"
    }
  }'
```

**List all users:**
```bash
curl -k https://localhost:11004/v1/users \
  -H "Authorization: Bearer $(cat testtoken)" | jq '.'
```

**Clear all users:**
```bash
just docker-clear-users
```

## setup-dns.sh

Configure host machine to resolve Docker service names via `/etc/hosts`.

See [DNS_SETUP.md](../docs/DNS_SETUP.md) for complete documentation.

### Usage

```bash
# Add DNS entries
sudo ./scripts/setup-dns.sh add

# Remove DNS entries
sudo ./scripts/setup-dns.sh remove

# Check status
sudo ./scripts/setup-dns.sh status

# Or use justfile commands
just dns-setup
just dns-remove
just dns-status
```

## Requirements

### For populate-users.sh

- `curl` - HTTP client
- `jq` - JSON processor
- Valid JWT token in `testtoken` file
- Running gRPC server with REST gateway

### For setup-dns.sh

- `sudo` access to modify `/etc/hosts`
- `sed` for file editing

## Troubleshooting

### populate-users.sh

**Error: Token file not found**
```bash
# Generate a new token
just gen-token > testtoken
```

**Error: Connection refused**
```bash
# Make sure Docker stack is running
just docker-up-build

# Or start local server
just run
```

**HTTP 401 Unauthorized**
```bash
# Token may be expired, regenerate it
just gen-token > testtoken
```

**HTTP 409 Conflict (user already exists)**
```bash
# Clear existing users first
just docker-clear-users

# Then populate again
just docker-populate-users
```

### setup-dns.sh

**Error: This script must be run as root**
```bash
# Use sudo
sudo ./scripts/setup-dns.sh add
```

**DNS entries not resolving**
```bash
# Check if entries were added
sudo ./scripts/setup-dns.sh status

# Verify /etc/hosts
grep grpc-example /etc/hosts
```

## See Also

- [Quick Start Guide](../docs/QUICKSTART.md) - Getting started with the Docker stack
- [Docker Commands](../docs/DOCKER_COMMANDS.md) - Docker Compose command reference
- [DNS Setup](../docs/DNS_SETUP.md) - Complete DNS configuration guide
